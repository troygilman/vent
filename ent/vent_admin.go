// Code generated by ent, DO NOT EDIT.

package ent

import (
	"context"
	"net/http"
	"vent"
	"vent/ent/user"
	"vent/templates/gui"
	"vent/utils"

	"github.com/starfederation/datastar-go/datastar"
)

func AuthMiddleware(client *Client, secret []byte) func(http.Handler) http.Handler {
	return func(next http.Handler) http.Handler {
		return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
			tokenCookie, err := r.Cookie("vent-auth-token")
			if err != nil {
				http.Redirect(w, r, "/admin/login/", http.StatusSeeOther)
				return
			}

			claims, err := utils.ParseSignedToken(secret, tokenCookie.Value)
			if err != nil {
				http.Redirect(w, r, "/admin/login/", http.StatusSeeOther)
				return
			}

			ctx := r.Context()
			ctx = context.WithValue(ctx, "claims", claims)
			r = r.WithContext(ctx)
			next.ServeHTTP(w, r)
		})
	}
}

func NewAdminHandler(client *Client, secret []byte) http.Handler {
	mux := http.NewServeMux()
	handler := &ventAdminHandler{
		client: client,
		secret: secret,
	}

	authMiddleware := AuthMiddleware(client, secret)

	// Unauthorized Paths
	mux.Handle("GET /admin/static/", http.StripPrefix("/admin/", vent.StaticDirHandler()))

	mux.Handle("GET /admin/login/", http.HandlerFunc(handler.getAdminLogin))
	mux.Handle("POST /admin/login/", http.HandlerFunc(handler.postAdminLogin))

	// Authorized Paths
	mux.Handle("GET /admin/", authMiddleware(http.HandlerFunc(handler.getAdmin)))

	mux.Handle("GET /admin/groups/", authMiddleware(http.HandlerFunc(handler.getAdminGroups)))

	mux.Handle("GET /admin/permissions/", authMiddleware(http.HandlerFunc(handler.getAdminPermissions)))

	mux.Handle("GET /admin/users/", authMiddleware(http.HandlerFunc(handler.getAdminUsers)))

	return mux
}

type ventAdminHandler struct {
	client *Client
	secret []byte
}

func (handler *ventAdminHandler) getAdmin(w http.ResponseWriter, r *http.Request) {
	if r.URL.Path != "/admin/" {
		w.WriteHeader(http.StatusNotFound)
		return
	}

	props := gui.AdminPageProps{
		LayoutProps: gui.LayoutProps{
			Schemas: handler.buildSchemaMetadata(),
		},
	}

	gui.AdminPage(props).Render(r.Context(), w)
}

func (handler *ventAdminHandler) getAdminLogin(w http.ResponseWriter, r *http.Request) {
	gui.LoginPage().Render(r.Context(), w)
}

type postAdminSignals struct {
	Email    string `json:"email"`
	Password string `json:"password"`
}

func (handler *ventAdminHandler) postAdminLogin(w http.ResponseWriter, r *http.Request) {
	var signals postAdminSignals
	if err := datastar.ReadSignals(r, &signals); err != nil {
		http.Error(w, err.Error(), http.StatusBadRequest)
		return
	}

	user, err := handler.client.User.Query().
		Where(user.EmailEQ(signals.Email)).
		Only(r.Context())
	if err != nil {
		http.Error(w, err.Error(), http.StatusBadRequest)
		return
	}

	if ok := utils.CheckPasswordHash(signals.Password, user.PasswordHash); !ok {
		http.Error(w, "Password does not match", http.StatusBadRequest)
		return
	}

	claims := utils.NewClaims(user.ID)
	signedToken, err := utils.CreateSignedToken(handler.secret, claims)
	if err != nil {
		http.Error(w, err.Error(), http.StatusBadRequest)
		return
	}

	http.SetCookie(w, &http.Cookie{
		Name:     "vent-auth-token",
		Value:    signedToken,
		Path:     "/",
		SameSite: http.SameSiteLaxMode,
	})

	sse := datastar.NewSSE(w, r)
	sse.Redirect("/admin/")
}

func (handler *ventAdminHandler) getAdminGroups(w http.ResponseWriter, r *http.Request) {
	ctx := r.Context()
	query := handler.client.Group.Query()
	results, err := query.All(ctx)
	if err != nil {
		panic(err)
	}
	print(results)

	props := gui.SchemaTablePageProps{
		LayoutProps: gui.LayoutProps{
			Schemas:          handler.buildSchemaMetadata(),
			ActiveSchemaName: "Group",
		},
	}

	gui.SchemaTablePage(props).Render(r.Context(), w)
}

func (handler *ventAdminHandler) getAdminPermissions(w http.ResponseWriter, r *http.Request) {
	ctx := r.Context()
	query := handler.client.Permission.Query()
	results, err := query.All(ctx)
	if err != nil {
		panic(err)
	}
	print(results)

	props := gui.SchemaTablePageProps{
		LayoutProps: gui.LayoutProps{
			Schemas:          handler.buildSchemaMetadata(),
			ActiveSchemaName: "Permission",
		},
	}

	gui.SchemaTablePage(props).Render(r.Context(), w)
}

func (handler *ventAdminHandler) getAdminUsers(w http.ResponseWriter, r *http.Request) {
	ctx := r.Context()
	query := handler.client.User.Query()
	results, err := query.All(ctx)
	if err != nil {
		panic(err)
	}
	print(results)

	props := gui.SchemaTablePageProps{
		LayoutProps: gui.LayoutProps{
			Schemas:          handler.buildSchemaMetadata(),
			ActiveSchemaName: "User",
		},
	}

	gui.SchemaTablePage(props).Render(r.Context(), w)
}

func (handler *ventAdminHandler) buildSchemaMetadata() []gui.SchemaMetadata {
	return []gui.SchemaMetadata{

		{
			Name: "Group",
			Path: "/admin/groups/",
		},

		{
			Name: "Permission",
			Path: "/admin/permissions/",
		},

		{
			Name: "User",
			Path: "/admin/users/",
		},
	}
}
