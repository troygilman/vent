// Code generated by ent, DO NOT EDIT.

package ent

import (
	"context"
	"net/http"
	"vent"
)

type VentConfig struct {
	Client    *Client
	SecretKey string
}

type Vent struct {
	config VentConfig
}

func NewVent(config VentConfig) (*Vent, error) {
	v := &Vent{
		config: config,
	}
	return v, nil
}

func (v *Vent) AuthMiddleware(next http.Handler) http.Handler {
	return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
		tokenCookie, err := r.Cookie("vent-auth-token")
		if err != nil {
			panic(err)
		}

		claims, err := vent.ParseSignedToken(v.config.SecretKey, tokenCookie.Raw)
		if err != nil {
			panic(err)
		}

		ctx := r.Context()
		ctx = context.WithValue(ctx, "claims", claims)
		r = r.WithContext(ctx)
		next.ServeHTTP(w, r)
	})
}

func (v *Vent) AdminHandler() http.Handler {
	mux := http.NewServeMux()
	handler := &ventAdminHandler{
		client: v.config.Client,
	}

	mux.Handle("/groups/", v.AuthMiddleware(http.HandlerFunc(handler.getGroups)))

	mux.Handle("/permissions/", v.AuthMiddleware(http.HandlerFunc(handler.getPermissions)))

	mux.Handle("/users/", v.AuthMiddleware(http.HandlerFunc(handler.getUsers)))

	return mux
}

type ventAdminHandler struct {
	client *Client
}

func (handler *ventAdminHandler) getGroups(w http.ResponseWriter, r *http.Request) {
	ctx := r.Context()
	query := handler.client.Group.Query()
	results, err := query.All(ctx)
	if err != nil {
		panic(err)
	}
	print(results)
	w.WriteHeader(200)
}

func (handler *ventAdminHandler) getPermissions(w http.ResponseWriter, r *http.Request) {
	ctx := r.Context()
	query := handler.client.Permission.Query()
	results, err := query.All(ctx)
	if err != nil {
		panic(err)
	}
	print(results)
	w.WriteHeader(200)
}

func (handler *ventAdminHandler) getUsers(w http.ResponseWriter, r *http.Request) {
	ctx := r.Context()
	query := handler.client.User.Query()
	results, err := query.All(ctx)
	if err != nil {
		panic(err)
	}
	print(results)
	w.WriteHeader(200)
}
