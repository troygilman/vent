{{ define "vent_admin" }}

{{ $pkg := base $.Config.Package }}
{{ template "header" $ }}

import (
	"context"
	"net/http"
	"vent"
	"vent/utils"
	"vent/templates/gui"
	"github.com/starfederation/datastar-go/datastar"
)

func AuthMiddleware(client *Client, secret []byte) func(http.Handler) http.Handler {
    return func(next http.Handler) http.Handler {
    	return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
    		tokenCookie, err := r.Cookie("vent-auth-token")
    		if err != nil {
    			http.Redirect(w, r, "{{ $.Annotations.VentConfig.AdminPath }}login/", http.StatusSeeOther)
    			return
    		}

    		claims, err := utils.ParseSignedToken(secret, tokenCookie.Value)
    		if err != nil {
    		    http.Redirect(w, r, "{{ $.Annotations.VentConfig.AdminPath }}login/", http.StatusSeeOther)
    			return
    		}

    		ctx := r.Context()
            ctx = context.WithValue(ctx, "claims", claims)
    		r = r.WithContext(ctx)
    		next.ServeHTTP(w, r)
    	})
    }
}

func NewAdminHandler(client *Client, secret []byte) http.Handler {
    mux := http.NewServeMux()
	handler := &ventAdminHandler{
		client: client,
		secret: secret,
	}

	authMiddleware := AuthMiddleware(client, secret)

    // Unauthorized Paths
    mux.Handle("GET {{ $.Annotations.VentConfig.AdminPath }}static/", http.StripPrefix("{{ $.Annotations.VentConfig.AdminPath }}", vent.StaticDirHandler()))

	mux.Handle("GET {{ $.Annotations.VentConfig.AdminPath }}login/", http.HandlerFunc(handler.getAdminLogin))
	mux.Handle("POST {{ $.Annotations.VentConfig.AdminPath }}login/", http.HandlerFunc(handler.postAdminLogin))

    // Authorized Paths
	mux.Handle("GET {{ $.Annotations.VentConfig.AdminPath }}", authMiddleware(http.HandlerFunc(handler.getAdmin)))

	{{ range $node := $.Nodes }}
	mux.Handle("GET {{ $.Annotations.VentConfig.AdminPath }}{{ lower $node.Name }}s/", authMiddleware(http.HandlerFunc(handler.getAdmin{{ $node.Name }}s)))
	{{ end }}
	return mux
}

type ventAdminHandler struct {
	client *Client
	secret []byte
}

func (handler *ventAdminHandler) getAdmin(w http.ResponseWriter, r *http.Request) {
    if r.URL.Path != "{{ $.Annotations.VentConfig.AdminPath }}" {
        w.WriteHeader(http.StatusNotFound)
        return
    }

    props := gui.AdminPageProps{
        LayoutProps: gui.LayoutProps{
            Schemas: []gui.SchemaMetadata{
	            {{ range $node := $.Nodes }}
                {
                    Name: "{{ $node.Name }}",
                    Path: "{{ $.Annotations.VentConfig.AdminPath }}{{ lower $node.Name }}s/",
                },
                {{ end }}
            },
        },
    }

    gui.AdminPage(props).Render(r.Context(), w)
}

func (handler *ventAdminHandler) getAdminLogin(w http.ResponseWriter, r *http.Request) {
	gui.LoginPage().Render(r.Context(), w)
}

type postAdminSignals struct {
    Email string `json:"email"`
    Password string `json:"password"`
}

func (handler *ventAdminHandler) postAdminLogin(w http.ResponseWriter, r *http.Request) {
    var signals postAdminSignals
    if err := datastar.ReadSignals(r, &signals); err != nil {
        http.Error(w, err.Error(), http.StatusBadRequest)
        return
    }

    user, err := handler.client.User.Query().
		Where(user.EmailEQ(signals.Email)).
		Only(r.Context())
	if err != nil {
		http.Error(w, err.Error(), http.StatusBadRequest)
		return
	}

	if ok := utils.CheckPasswordHash(signals.Password, user.PasswordHash); !ok {
	    http.Error(w, "Password does not match", http.StatusBadRequest)
		return
	}

    claims := utils.NewClaims(user.ID)
    signedToken, err := utils.CreateSignedToken(handler.secret, claims)
    if err != nil {
        http.Error(w, err.Error(), http.StatusBadRequest)
		return
    }

	http.SetCookie(w, &http.Cookie{
		Name: "vent-auth-token",
		Value: signedToken,
		Path: "/",
		SameSite: http.SameSiteLaxMode,
	})

	sse := datastar.NewSSE(w, r)
	sse.Redirect("{{ $.Annotations.VentConfig.AdminPath }}")
}

{{ range $node := $.Nodes }}
func (handler *ventAdminHandler) getAdmin{{ $node.Name }}s(w http.ResponseWriter, r *http.Request) {
   	ctx := r.Context()
   	query := handler.client.{{ $node.Name }}.Query()
   	results, err := query.All(ctx)
    if err != nil {
    	panic(err)
    }
    print(results)
}
{{ end }}

{{ end }}
