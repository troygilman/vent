{{ define "vent_admin" }}

{{ $pkg := base $.Config.Package }}
{{ template "header" $ }}

{{ $adminPath := $.Annotations.VentConfig.AdminPath }}

import (
	"context"
	"net/http"
	"log"
	"strconv"
	"vent"
	"vent/utils"
	"vent/templates/gui"
	"github.com/starfederation/datastar-go/datastar"
)

type AdminConfig struct {
    Client *Client
    Secret []byte
}

func AuthMiddleware(config AdminConfig) func(http.Handler) http.Handler {
    return func(next http.Handler) http.Handler {
    	return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
    		tokenCookie, err := r.Cookie("vent-auth-token")
    		if err != nil {
    			http.Redirect(w, r, "{{ $adminPath }}login/", http.StatusSeeOther)
    			return
    		}

    		claims, err := utils.ParseSignedToken(config.Secret, tokenCookie.Value)
    		if err != nil {
    		    http.Redirect(w, r, "{{ $adminPath }}login/", http.StatusSeeOther)
    			return
    		}

    		ctx := r.Context()
            ctx = context.WithValue(ctx, "claims", claims)
    		r = r.WithContext(ctx)
    		next.ServeHTTP(w, r)
    	})
    }
}

func NewAdminHandler(config AdminConfig) http.Handler {
    secretProvider := auth.SecretProviderFunc(func() []byte{
        return config.Secret
    })
    credentialAuthenticator := auth.NewBCryptCredentialAuthenticator()
    loginHandler := func(ctx context.Context, credential vent.UserCredential) (id int, err error) {
        user, err := config.Client.AuthUser.Query().
    		Where(authuser.EmailEQ(credential.Email)).
    		Only(ctx)
    	if err != nil {
    		return 0, err
    	}
        return user.ID, credentialAuthenticator.Authenticate(credential.Password, user.PasswordHash)
    }
    handler := vent.NewHandler(
        secretProvider,
        loginHandler,
    )

    {{ range $node := $.Nodes }}
    {{ $tableFields := tableFields $node }}
    handler.RegisterSchema(vent.SchemaParams{
        Name: "{{ $node.Name }}",
        QueryProviderFunc: func() vent.Query {
            return config.Client.{{ $node.Name }}.Query().VentQuery()
        },
        SchemaClient: &{{ $node.Name }}SchemaClient{
            client: config.Client.{{ $node.Name }},
        },
        Columns: []vent.SchemaColumn{
            {
                Name: "id",
                Label: "ID",
                Type: "int",
            },
            {{ range $field := $tableFields }}
            {
                Name: "{{ $field.Name }}",
                Label: "{{ pascal $field.Name }}",
                Type: "{{ $field.Type.Type }}",
            },
            {{ end }}
        },
    })
    {{ end }}

    return handler
}

{{ range $node := $.Nodes }}
{{ $tableFields := tableFields $node }}
type {{ $node.Name }}SchemaClient struct {
    client *{{ $node.Name }}Client
}

func (c *{{ $node.Name }}SchemaClient) Query(
	ctx context.Context,
	predicates []vent.Predicate,
	orders []vent.OrderOption,
) (iter.Seq[vent.Entity], error) {
    q := c.client.Query()
	for _, p := range predicates {
		q = q.Where(p)
	}
	for _, o := range orders {
		q = q.Order(o)
	}
	result, err := q.All(ctx)
	if err != nil {
		return nil, err
	}
	return func(yield func(vent.Entity) bool) {
		for _, entity := range result {
			if !yield(entity) {
				return
			}
		}
	}, nil
}

func (c *{{ $node.Name }}SchemaClient) Update(
    ctx context.Context,
    predicates []vent.Predicate,
    mutations []vent.Mutation2,
) error {
    q := c.client.Update()
    for _, p := range predicates {
        q = q.Where(p)
    }
    for _, m := range mutations {
        switch m.FieldName {
        {{ range $field := $tableFields }}
        case "{{ $field.Name }}":
            q = q.Set{{ pascal $field.Name }}(m.Value.({{ $field.Type }}))
        {{ end }}
        }
    }
    return q.Exec(ctx)
}
{{ end }}

func NewAdminHandler2(config AdminConfig) http.Handler {
    mux := http.NewServeMux()
	handler := &ventAdminHandler{
		AdminConfig: config,
	}

	authMiddleware := AuthMiddleware(config)

    // Unauthorized Paths
    mux.Handle("GET {{ $adminPath }}static/", http.StripPrefix("{{ $adminPath }}", vent.StaticDirHandler()))

	mux.Handle("GET {{ $adminPath }}login/", http.HandlerFunc(handler.getAdminLogin))
	mux.Handle("POST {{ $adminPath }}login/", http.HandlerFunc(handler.postAdminLogin))

    // Authorized Paths
	mux.Handle("GET {{ $adminPath }}", authMiddleware(http.HandlerFunc(handler.getAdmin)))

	{{ range $node := $.Nodes }}
	mux.Handle("GET {{ $adminPath }}{{ lower $node.Name }}s/", authMiddleware(http.HandlerFunc(handler.getAdmin{{ $node.Name }}s)))
	mux.Handle("GET {{ $adminPath }}{{ lower $node.Name }}s/{id}/", authMiddleware(http.HandlerFunc(handler.getAdmin{{ $node.Name }}Detail)))
	mux.Handle("POST {{ $adminPath }}{{ lower $node.Name }}s/{id}/", authMiddleware(http.HandlerFunc(handler.postAdmin{{ $node.Name }}Detail)))
	{{ end }}
	return mux
}

type ventAdminHandler struct {
	AdminConfig
}

func (handler *ventAdminHandler) getAdmin(w http.ResponseWriter, r *http.Request) {
    if r.URL.Path != "{{ $adminPath }}" {
        w.WriteHeader(http.StatusNotFound)
        return
    }

    props := gui.AdminPageProps{
        LayoutProps: gui.LayoutProps{
            Schemas: handler.buildSchemaMetadata(),
        },
    }

    gui.AdminPage(props).Render(r.Context(), w)
}

func (handler *ventAdminHandler) getAdminLogin(w http.ResponseWriter, r *http.Request) {
    props := gui.LoginProps{}
	gui.LoginPage(props).Render(r.Context(), w)
}

type postAdminSignals struct {
    Email string `json:"email"`
    Password string `json:"password"`
}

func (handler *ventAdminHandler) postAdminLogin(w http.ResponseWriter, r *http.Request) {
    var signals postAdminSignals
    if err := datastar.ReadSignals(r, &signals); err != nil {
		http.Error(w, err.Error(), http.StatusBadRequest)
		return
    }

    err := func() error {
        user, err := handler.Client.AuthUser.Query().
    		Where(authuser.EmailEQ(signals.Email)).
    		Only(r.Context())
    	if err != nil {
    		return err
    	}

    	//if err := utils.CheckPasswordHash(signals.Password, user.PasswordHash); err != nil {
    	//    return err
    	//}

        claims := utils.NewClaims(user.ID)
        signedToken, err := utils.CreateSignedToken(handler.Secret, claims)
        if err != nil {
            return err
        }

    	http.SetCookie(w, &http.Cookie{
    		Name: "vent-auth-token",
    		Value: signedToken,
    		Path: "/",
    		SameSite: http.SameSiteLaxMode,
    	})

		sse := datastar.NewSSE(w, r)
		sse.Redirect("{{ $adminPath }}")
        return nil
	}()
	if err != nil {
		log.Println(err.Error())
		sse := datastar.NewSSE(w, r)
		if IsNotFound(err) {
			sse.PatchElementTempl(gui.Login(gui.LoginProps{
				EmailError: "User with email not found",
			}))
		} else if errors.Is(err, vent.ErrPasswordMismatch) {
			sse.PatchElementTempl(gui.Login(gui.LoginProps{
				PasswordErrors: []string{
					"Invalid password",
				},
			}))
		}
	}
}

{{ range $node := $.Nodes }}
{{ $tableFields := tableFields $node }}
func (handler *ventAdminHandler) getAdmin{{ $node.Name }}s(w http.ResponseWriter, r *http.Request) {
   	ctx := r.Context()
   	query := handler.Client.{{ $node.Name }}.Query()
   	results, err := query.Order({{ lower $node.Name }}.ByID()).All(ctx)
    if err != nil {
    	panic(err)
    }

    rows := make([][]string, len(results))
    for idx, result := range results {
        rows[idx] = []string{
            strconv.Itoa(result.ID),
            {{ range $field := $tableFields }}
            utils.Stringify(result.{{ pascal $field.Name }}, "{{ $field.Type.Type }}"),
            {{ end }}
        }
    }

    props := gui.SchemaTableProps{
        LayoutProps: gui.LayoutProps{
            Schemas: handler.buildSchemaMetadata(),
            ActiveSchemaName: "{{ $node.Name }}",
        },
        Columns: []gui.SchemaTableColumn{
            {
                Name: "id",
                Label: "ID",
                Type: "int",
            },
            {{ range $field := $tableFields }}
            {
                Name: "{{ $field.Name }}",
                Label: "{{ pascal $field.Name }}",
                Type: "{{ $field.Type.Type }}",
            },
            {{ end }}
        },
        Rows: rows,
        AdminPath: "{{ $adminPath }}",
        SchemaName: "{{ $node.Name }}",
    }

    gui.SchemaTablePage(props).Render(r.Context(), w)
}

func (handler *ventAdminHandler) getAdmin{{ $node.Name }}Detail(w http.ResponseWriter, r *http.Request) {
   	ctx := r.Context()

    id, err := strconv.Atoi(r.PathValue("id"))
	if err != nil {
		panic(err)
	}

    component, err := handler.build{{ $node.Name }}DetailComponent(ctx, id)
    if err != nil {
        http.Error(w, err.Error(), http.StatusInternalServerError)
        return
    }

    component.Render(ctx, w)
}

func (handler *ventAdminHandler) postAdmin{{ $node.Name }}Detail(w http.ResponseWriter, r *http.Request) {
    id, err := strconv.Atoi(r.PathValue("id"))
	if err != nil {
		http.Error(w, err.Error(), http.StatusBadRequest)
		return
	}

    signals := &{{ $node.Name }}{}
    if err := datastar.ReadSignals(r, &signals); err != nil {
		http.Error(w, err.Error(), http.StatusBadRequest)
		return
    }

    stmt := handler.Client.{{ $node.Name }}.UpdateOneID(id)

    {{ range $field := $node.Fields }}
    {{ if not $field.Sensitive }}
    stmt = stmt.Set{{ pascal $field.Name }}(signals.{{ pascal $field.Name }})
    {{ end }}
    {{ end }}

    if err := stmt.Exec(r.Context()); err != nil {
        http.Error(w, err.Error(), http.StatusInternalServerError)
		return
    }

    component, err := handler.build{{ $node.Name }}DetailComponent(r.Context(), id)
    if err != nil {
        http.Error(w, err.Error(), http.StatusInternalServerError)
        return
    }

    sse := datastar.NewSSE(w, r)
    sse.PatchElementTempl(component)
}

func (handler *ventAdminHandler) build{{ $node.Name }}DetailComponent(ctx context.Context, id int) (templ.Component, error) {
   	result, err := handler.Client.{{ $node.Name }}.Get(ctx, id)
    if err != nil {
    	return nil, err
    }

    props := gui.SchemaDetailProps{
        LayoutProps: gui.LayoutProps{
            Schemas: handler.buildSchemaMetadata(),
            ActiveSchemaName: "{{ $node.Name }}",
        },
        Fields: []gui.SchemaDetailFieldProps{
            {{ range $field := $node.Fields }}
            {{ if not $field.Sensitive }}
            {
                Name: "{{ $field.Name }}",
                Label: "{{ pascal $field.Name }}",
                Type: "{{ $field.Type.Type }}",
                Value: utils.Stringify(result.{{ pascal $field.Name }}, "{{ $field.Type.Type }}"),
            },
            {{ end }}
            {{ end }}
        },
        AdminPath: "{{ $adminPath }}",
        SchemaName: "{{ $node.Name }}",
        EntityID: result.ID,
    }

    return gui.SchemaDetailPage(props), nil
}
{{ end }}


func (handler *ventAdminHandler) buildSchemaMetadata() []gui.SchemaMetadata {
    return []gui.SchemaMetadata{
        {{ range $node := $.Nodes }}
        {
            Name: "{{ $node.Name }}",
            Path: "{{ $adminPath }}{{ lower $node.Name }}s/",
        },
        {{ end }}
    }
}

{{ end }}
